---
  - hosts: localhost
    sudo: yes

    vars:
      - script_dir: "/root/backup"
      - exclude_file: "{{ script_dir }}/exclude.txt"
      - backup_name: "dx5-biotek4"
      - backup_drive_uuid: 9be50e2d-5087-4072-90d3-db0b7188b24d
      - backup_mount_point: "/snapshot-backups-usb"
      - backup_log: "/var/log/rsnapshot-backups.log"
      - fs_type: "ext2"
      - script_hourly: "{{ script_dir }}/make_snapshot_hourly.sh"
      - script_daily: "{{ script_dir }}/make_snapshot_daily.sh"
      - script_weekly: "{{ script_dir }}/make_snapshot_weekly.sh"
      - script_monthly: "{{ script_dir }}/make_snapshot_monthly.sh"
      - script_remount: "{{ script_dir }}/remount_{{ backup_drive_uuid }}.sh"
      - script_swapoff_swapon: "{{ script_dir }}/swapoff_swapon.sh"
      - retain_hourly: "6"
      - retain_daily: "7"
      - retain_weekly: "4"
      - retain_monthly: "12"

    tasks:
      #- name: install rsnapshot
      #  apt: name=rsnapshot state=present
      - name: template rsnapshot config
        template: src=templates/rsnapshot.conf dest=/etc/rsnapshot.conf backup=yes

      - name: create script directory
        file: path={{ script_dir }} state=directory

      - name: template hourly backup script
        template: src=make_snapshot_hourly.sh dest={{ script_hourly }} mode=0700 owner=root
      - name: template daily backup script
        template: src=make_snapshot_daily.sh dest={{ script_daily }} mode=0700 owner=root
      - name: template weekly backup script
        template: src=make_snapshot_weekly.sh dest={{ script_weekly }} mode=0700 owner=root
      - name: template daily backup script
        template: src=make_snapshot_monthly.sh dest={{ script_monthly }} mode=0700 owner=root
      - name: template remount script
        template: src=templates/remount.sh dest={{ script_remount }} mode=0700 owner=root
      - name: template swapoff_swapon script
        template: src=templates/swapoff_swapon.sh dest={{ script_swapoff_swapon }} mode=0700 owner=root

      - name: create hourly backup job
        cron: name="hourly backup" minute="3" hour="*/4" job="{{ script_hourly }} >> {{ backup_log }} 2>&1"
      - name: create daily backup job
        cron: name="daily backup" minute="50" hour="21" job="{{ script_daily }} >> {{ backup_log }} 2>&1"
      - name: create weekly backup job
        cron: name="weekly backup" minute="40" hour="21" weekday="3" job="{{ script_weekly }} >> {{ backup_log }} 2>&1"
      - name: create monthly backup job
        cron: name="monthly backup" minute="30" hour="21" day="1-7" job="{{ script_monthly }} >> {{ backup_log }} 2>&1"
